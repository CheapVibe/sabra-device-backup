{% extends 'base.html' %}

{% block title %}Restore Preview - System Backup{% endblock %}

{% block content %}
<div class="page-header d-flex justify-content-between align-items-center">
    <div>
        <h1><i class="bi bi-eye me-2"></i>Restore Preview</h1>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{% url 'dashboard' %}">Dashboard</a></li>
                <li class="breadcrumb-item"><a href="{% url 'system_backup:dashboard' %}">System Backup</a></li>
                <li class="breadcrumb-item active">Preview</li>
            </ol>
        </nav>
    </div>
    <div>
        <a href="{% url 'system_backup:cancel' %}" class="btn btn-outline-secondary">
            <i class="bi bi-x-lg me-1"></i> Cancel Restore
        </a>
    </div>
</div>

<!-- Backup Info Card -->
<div class="card mb-4 border-primary">
    <div class="card-body py-3">
        <div class="row align-items-center">
            <div class="col-auto">
                <i class="bi bi-file-earmark-lock fs-1 text-primary"></i>
            </div>
            <div class="col">
                <h5 class="mb-1">{{ backup_info.metadata.filename }}</h5>
                <div class="text-muted small">
                    <span class="me-3"><i class="bi bi-calendar me-1"></i>Created: {{ backup_info.metadata.created_at }}</span>
                    <span class="me-3"><i class="bi bi-code-square me-1"></i>Version: {{ backup_info.metadata.version }}</span>
                    {% if backup_info.metadata.backup_name %}
                    <span class="me-3"><i class="bi bi-tag me-1"></i>{{ backup_info.metadata.backup_name }}</span>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Backup Contents Summary -->
<div class="card mb-4 shadow-sm">
    <div class="card-header bg-light">
        <h5 class="card-title mb-0"><i class="bi bi-box me-2"></i>Backup Contents</h5>
    </div>
    <div class="card-body">
        <div class="row g-3">
            {% for component, data in backup_info.components.items %}
            <div class="col-6 col-md-4 col-lg-3">
                <div class="border rounded p-3 h-100 {% if data.count > 0 %}bg-light{% else %}bg-white text-muted{% endif %}">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <span class="badge rounded-pill {% if data.count > 0 %}bg-primary{% else %}bg-secondary{% endif %} mb-1">
                                {{ data.count }}
                            </span>
                            <h6 class="mb-0">{{ data.label }}</h6>
                        </div>
                        {% if data.count > 0 %}
                        <i class="bi bi-check-circle-fill text-success"></i>
                        {% else %}
                        <i class="bi bi-dash-circle text-muted"></i>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<form method="post" action="{% url 'system_backup:preview' %}" id="restoreForm">
    {% csrf_token %}
    
    <!-- Component Selection -->
    <div class="card mb-4 shadow-sm">
        <div class="card-header bg-success text-white">
            <h5 class="card-title mb-0"><i class="bi bi-check2-square me-2"></i>Select Components to Restore</h5>
        </div>
        <div class="card-body">
            <p class="text-muted mb-3">Choose which components to restore. Dependencies will be handled automatically.</p>
            
            <div class="row g-3">
                <!-- Inventory Section -->
                <div class="col-lg-6">
                    <div class="border rounded p-3 h-100">
                        <h6 class="text-muted mb-3"><i class="bi bi-server me-1"></i> Inventory</h6>
                        
                        <div class="form-check mb-2">
                            <input class="form-check-input restore-check" type="checkbox" id="restore_credentials" 
                                   name="restore_credentials" value="1"
                                   {% if backup_info.components.credential_profiles.count > 0 %}checked{% else %}disabled{% endif %}>
                            <label class="form-check-label {% if backup_info.components.credential_profiles.count == 0 %}text-muted{% endif %}" for="restore_credentials">
                                <strong>Credentials</strong>
                                <span class="badge {% if backup_info.components.credential_profiles.count > 0 %}bg-success{% else %}bg-secondary{% endif %} ms-1">{{ backup_info.components.credential_profiles.count }}</span>
                                {% if backup_info.components.credential_profiles.count > 0 %}
                                <i class="bi bi-lock-fill text-success ms-1" title="Contains passwords"></i>
                                {% endif %}
                            </label>
                        </div>
                        
                        <div class="form-check mb-2">
                            <input class="form-check-input restore-check" type="checkbox" id="restore_groups" 
                                   name="restore_groups" value="1"
                                   {% if backup_info.components.device_groups.count > 0 %}checked{% else %}disabled{% endif %}>
                            <label class="form-check-label {% if backup_info.components.device_groups.count == 0 %}text-muted{% endif %}" for="restore_groups">
                                <strong>Device Groups</strong>
                                <span class="badge {% if backup_info.components.device_groups.count > 0 %}bg-info{% else %}bg-secondary{% endif %} ms-1">{{ backup_info.components.device_groups.count }}</span>
                            </label>
                        </div>
                        
                        <div class="form-check mb-2">
                            <input class="form-check-input restore-check" type="checkbox" id="restore_vendors" 
                                   name="restore_vendors" value="1"
                                   {% if backup_info.components.vendors.count > 0 %}checked{% else %}disabled{% endif %}>
                            <label class="form-check-label {% if backup_info.components.vendors.count == 0 %}text-muted{% endif %}" for="restore_vendors">
                                <strong>Vendors</strong>
                                <span class="badge {% if backup_info.components.vendors.count > 0 %}bg-secondary{% else %}bg-light text-muted{% endif %} ms-1">{{ backup_info.components.vendors.count }}</span>
                            </label>
                        </div>
                        
                        <div class="form-check mb-2">
                            <input class="form-check-input restore-check" type="checkbox" id="restore_devices" 
                                   name="restore_devices" value="1"
                                   data-requires="restore_credentials,restore_groups"
                                   {% if backup_info.components.devices.count > 0 %}checked{% else %}disabled{% endif %}>
                            <label class="form-check-label {% if backup_info.components.devices.count == 0 %}text-muted{% endif %}" for="restore_devices">
                                <strong>Devices</strong>
                                <span class="badge {% if backup_info.components.devices.count > 0 %}bg-primary{% else %}bg-secondary{% endif %} ms-1">{{ backup_info.components.devices.count }}</span>
                            </label>
                            <div class="form-text small text-muted ms-4">Requires: Credentials, Groups</div>
                        </div>
                    </div>
                </div>
                
                <!-- Backup System Section -->
                <div class="col-lg-6">
                    <div class="border rounded p-3 h-100">
                        <h6 class="text-muted mb-3"><i class="bi bi-clock-history me-1"></i> Backup System</h6>
                        
                        <div class="form-check mb-2">
                            <input class="form-check-input restore-check" type="checkbox" id="restore_jobs" 
                                   name="restore_jobs" value="1"
                                   data-requires="restore_devices,restore_groups"
                                   {% if backup_info.components.backup_jobs.count > 0 %}checked{% else %}disabled{% endif %}>
                            <label class="form-check-label {% if backup_info.components.backup_jobs.count == 0 %}text-muted{% endif %}" for="restore_jobs">
                                <strong>Backup Jobs</strong>
                                <span class="badge {% if backup_info.components.backup_jobs.count > 0 %}bg-warning text-dark{% else %}bg-secondary{% endif %} ms-1">{{ backup_info.components.backup_jobs.count }}</span>
                            </label>
                            <div class="form-text small text-muted ms-4">Requires: Devices, Groups</div>
                        </div>
                        
                        <div class="form-check mb-2">
                            <input class="form-check-input restore-check" type="checkbox" id="restore_snapshots" 
                                   name="restore_snapshots" value="1"
                                   data-requires="restore_devices"
                                   {% if backup_info.components.config_snapshots.count > 0 %}{% else %}disabled{% endif %}>
                            <label class="form-check-label {% if backup_info.components.config_snapshots.count == 0 %}text-muted{% endif %}" for="restore_snapshots">
                                <strong>Config Snapshots</strong>
                                <span class="badge {% if backup_info.components.config_snapshots.count > 0 %}bg-dark{% else %}bg-secondary{% endif %} ms-1">{{ backup_info.components.config_snapshots.count }}</span>
                            </label>
                            <div class="form-text small text-muted ms-4">Requires: Devices (Historical data - skips existing)</div>
                        </div>
                        
                        <hr>
                        <div class="form-check">
                            <input class="form-check-input restore-check" type="checkbox" id="restore_mail" 
                                   name="restore_mail" value="1"
                                   {% if backup_info.components.mail_config.count > 0 %}checked{% else %}disabled{% endif %}>
                            <label class="form-check-label {% if backup_info.components.mail_config.count == 0 %}text-muted{% endif %}" for="restore_mail">
                                <strong>Mail Configuration</strong>
                                {% if backup_info.components.mail_config.count > 0 %}
                                <i class="bi bi-lock-fill text-success ms-1" title="Contains SMTP credentials"></i>
                                {% endif %}
                                <span class="badge {% if backup_info.components.mail_config.count > 0 %}bg-info{% else %}bg-secondary{% endif %} ms-1">{{ backup_info.components.mail_config.count }}</span>
                            </label>
                            {% if backup_info.components.mail_config.count > 0 %}
                            <div class="form-text small text-warning ms-4">
                                <i class="bi bi-exclamation-triangle me-1"></i>Will always update existing settings (ignores conflict mode)
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Restore Options -->
    <div class="card mb-4 shadow-sm">
        <div class="card-header bg-light">
            <h5 class="card-title mb-0"><i class="bi bi-gear me-2"></i>Restore Options</h5>
        </div>
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-6">
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="radio" name="conflict_mode" 
                               id="conflict_skip" value="skip" checked>
                        <label class="form-check-label" for="conflict_skip">
                            <strong>Skip existing</strong>
                            <div class="form-text">Items already in your database will not be modified</div>
                        </label>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="radio" name="conflict_mode" 
                               id="conflict_update" value="update">
                        <label class="form-check-label" for="conflict_update">
                            <strong>Update existing</strong>
                            <div class="form-text">Existing items will be updated with backup values</div>
                        </label>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="d-flex gap-3">
        <a href="{% url 'system_backup:cancel' %}" class="btn btn-outline-secondary btn-lg">
            <i class="bi bi-arrow-left me-1"></i> Cancel
        </a>
        <button type="submit" class="btn btn-primary btn-lg flex-grow-1" id="previewBtn">
            <i class="bi bi-eye me-2"></i>Preview Changes
        </button>
    </div>
</form>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Handle dependency requirements
    const restoreChecks = document.querySelectorAll('.restore-check');
    
    restoreChecks.forEach(function(check) {
        const requires = check.dataset.requires;
        if (requires) {
            check.addEventListener('change', function() {
                if (this.checked) {
                    // Auto-check required dependencies
                    requires.split(',').forEach(function(depId) {
                        const dep = document.getElementById(depId);
                        if (dep) {
                            dep.checked = true;
                            dep.dispatchEvent(new Event('change'));
                        }
                    });
                }
            });
        }
    });
    
    // Form submission
    document.getElementById('restoreForm').addEventListener('submit', function() {
        const btn = document.getElementById('previewBtn');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Analyzing...';
    });
});
</script>
{% endblock %}
