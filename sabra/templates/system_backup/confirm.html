{% extends 'base.html' %}

{% block title %}Confirm Restore - System Backup{% endblock %}

{% block content %}
<div class="page-header d-flex justify-content-between align-items-center">
    <div>
        <h1><i class="bi bi-clipboard-check me-2"></i>Confirm Restore</h1>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{% url 'dashboard' %}">Dashboard</a></li>
                <li class="breadcrumb-item"><a href="{% url 'system_backup:dashboard' %}">System Backup</a></li>
                <li class="breadcrumb-item"><a href="{% url 'system_backup:preview' %}">Preview</a></li>
                <li class="breadcrumb-item active">Confirm</li>
            </ol>
        </nav>
    </div>
</div>

<!-- Warnings Section -->
{% if preview.warnings %}
<div class="alert alert-warning shadow-sm mb-4">
    <h5 class="alert-heading"><i class="bi bi-exclamation-triangle-fill me-2"></i>Dependency Warnings</h5>
    <p class="mb-2">The following issues were detected that may affect the restore:</p>
    <ul class="mb-0">
        {% for warning in preview.warnings %}
        <li>{{ warning }}</li>
        {% endfor %}
    </ul>
</div>
{% endif %}

<!-- Summary Statistics -->
<div class="row g-3 mb-4">
    <div class="col-6 col-md-2">
        <div class="card border-success h-100">
            <div class="card-body text-center py-3">
                <i class="bi bi-plus-circle-fill fs-3 text-success"></i>
                <h3 class="mb-0 text-success">{{ preview.summary.new }}</h3>
                <small class="text-muted">New</small>
            </div>
        </div>
    </div>
    <div class="col-6 col-md-2">
        <div class="card border-warning h-100">
            <div class="card-body text-center py-3">
                <i class="bi bi-pencil-fill fs-3 text-warning"></i>
                <h3 class="mb-0 text-warning">{{ preview.summary.modified }}</h3>
                <small class="text-muted">Modified</small>
            </div>
        </div>
    </div>
    <div class="col-6 col-md-2">
        <div class="card border-info h-100">
            <div class="card-body text-center py-3">
                <i class="bi bi-skip-forward-fill fs-3 text-info"></i>
                <h3 class="mb-0 text-info">{{ preview.summary.skipped }}</h3>
                <small class="text-muted">Skipped</small>
            </div>
        </div>
    </div>
    <div class="col-6 col-md-2">
        <div class="card border-secondary h-100">
            <div class="card-body text-center py-3">
                <i class="bi bi-dash-circle fs-3 text-secondary"></i>
                <h3 class="mb-0 text-secondary">{{ preview.summary.unchanged }}</h3>
                <small class="text-muted">Unchanged</small>
            </div>
        </div>
    </div>
    <div class="col-12 col-md-4">
        <div class="card bg-light border-0 h-100">
            <div class="card-body py-3">
                <div class="d-flex align-items-center h-100">
                    <div class="me-3">
                        <i class="bi bi-info-circle fs-3 text-primary"></i>
                    </div>
                    <div>
                        <strong>Conflict Mode:</strong> 
                        {% if conflict_mode == 'update' %}
                        <span class="badge bg-warning text-dark">Update existing items</span>
                        {% else %}
                        <span class="badge bg-success">Skip existing items</span>
                        {% endif %}
                        <div class="text-muted small mt-1">
                            {% if conflict_mode == 'update' %}
                            Existing items will be overwritten with backup values.
                            {% else %}
                            Existing items will remain unchanged.
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Detailed Changes -->
{% for component, changes in preview.components.items %}
{% if changes.items %}
<div class="card mb-4 shadow-sm">
    <div class="card-header bg-light d-flex justify-content-between align-items-center">
        <h5 class="card-title mb-0">
            {% if component == 'credential_profiles' %}
            <i class="bi bi-key me-2"></i>Credential Profiles
            {% elif component == 'device_groups' %}
            <i class="bi bi-collection me-2"></i>Device Groups
            {% elif component == 'vendors' %}
            <i class="bi bi-cpu me-2"></i>Vendors
            {% elif component == 'devices' %}
            <i class="bi bi-hdd-network me-2"></i>Devices
            {% elif component == 'backup_jobs' %}
            <i class="bi bi-calendar-check me-2"></i>Backup Jobs
            {% elif component == 'config_snapshots' %}
            <i class="bi bi-file-earmark-code me-2"></i>Config Snapshots
            {% elif component == 'mail_config' %}
            <i class="bi bi-envelope me-2"></i>Mail Configuration
            {% else %}
            <i class="bi bi-box me-2"></i>{{ component }}
            {% endif %}
        </h5>
        <div>
            {% if changes.new_count %}<span class="badge bg-success me-1">{{ changes.new_count }} new</span>{% endif %}
            {% if changes.modified_count %}<span class="badge bg-warning text-dark me-1">{{ changes.modified_count }} modified</span>{% endif %}
            {% if changes.skipped_count %}<span class="badge bg-info me-1">{{ changes.skipped_count }} skipped</span>{% endif %}
            {% if changes.unchanged_count %}<span class="badge bg-secondary">{{ changes.unchanged_count }} unchanged</span>{% endif %}
        </div>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover table-striped mb-0">
                <thead class="table-light">
                    <tr>
                        <th style="width: 50px;">Status</th>
                        <th>Item</th>
                        {% if component != 'mail_config' %}
                        <th>Details</th>
                        {% endif %}
                        {% if changes.modified_count > 0 %}
                        <th>Changes</th>
                        {% endif %}
                    </tr>
                </thead>
                <tbody>
                    {% for item in changes.items %}
                    <tr class="{% if item.status == 'new' %}table-success{% elif item.status == 'modified' %}table-warning{% elif item.status == 'skipped' %}table-info{% endif %}">
                        <td class="text-center">
                            {% if item.status == 'new' %}
                            <span class="badge bg-success"><i class="bi bi-plus-lg"></i> NEW</span>
                            {% elif item.status == 'modified' %}
                            <span class="badge bg-warning text-dark"><i class="bi bi-pencil"></i> MOD</span>
                            {% elif item.status == 'skipped' %}
                            <span class="badge bg-info"><i class="bi bi-skip-forward"></i> SKIP</span>
                            {% else %}
                            <span class="badge bg-secondary"><i class="bi bi-dash"></i></span>
                            {% endif %}
                        </td>
                        <td>
                            <strong>{{ item.name }}</strong>
                            {% if item.identifier %}
                            <br><code class="small">{{ item.identifier }}</code>
                            {% endif %}
                        </td>
                        {% if component != 'mail_config' %}
                        <td class="small text-muted">
                            {% if item.details %}
                            {% for key, value in item.details.items %}
                            <span class="me-2">{{ key }}: <strong>{{ value }}</strong></span>
                            {% endfor %}
                            {% endif %}
                        </td>
                        {% endif %}
                        {% if changes.modified_count > 0 or changes.skipped_count > 0 %}
                        <td>
                            {% if item.status == 'modified' and item.changes %}
                            <ul class="list-unstyled mb-0 small">
                                {% for field in item.changes %}
                                <li>
                                    <i class="bi bi-pencil-square text-warning me-1"></i>
                                    <span class="text-muted">{{ field }}</span>
                                </li>
                                {% endfor %}
                            </ul>
                            {% elif item.status == 'skipped' and item.changes %}
                            <span class="text-info small">
                                <i class="bi bi-info-circle me-1"></i>
                                Differs in: {{ item.changes|join:", " }}
                            </span>
                            {% elif item.status == 'new' %}
                            <span class="text-success small"><i class="bi bi-plus-circle me-1"></i>Will be created</span>
                            {% else %}
                            <span class="text-muted small">â€”</span>
                            {% endif %}
                        </td>
                        {% endif %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endif %}
{% endfor %}

<!-- Action Buttons -->
<div class="card shadow-sm mb-4">
    <div class="card-body">
        <div class="row align-items-center">
            <div class="col-md-7">
                <h5 class="mb-2"><i class="bi bi-exclamation-diamond me-2 text-primary"></i>Ready to restore?</h5>
                <p class="text-muted mb-md-0">
                    This action will add <strong class="text-success">{{ preview.summary.new }} new items</strong>
                    {% if conflict_mode == 'update' and preview.summary.modified > 0 %}
                    and update <strong class="text-warning">{{ preview.summary.modified }} existing items</strong>
                    {% endif %}.
                    This operation is atomic and can be canceled.
                </p>
            </div>
            <div class="col-md-5">
                <form method="post" action="{% url 'system_backup:restore' %}" id="restoreForm">
                    {% csrf_token %}
                    <div class="d-flex gap-2">
                        <a href="{% url 'system_backup:cancel' %}" class="btn btn-outline-secondary">
                            <i class="bi bi-x-lg me-1"></i> Cancel
                        </a>
                        <a href="{% url 'system_backup:preview' %}" class="btn btn-outline-primary">
                            <i class="bi bi-arrow-left me-1"></i> Back
                        </a>
                        <button type="submit" class="btn btn-success flex-grow-1" id="restoreBtn">
                            <i class="bi bi-check2-circle me-2"></i>Apply Restore
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('restoreForm').addEventListener('submit', function() {
        const btn = document.getElementById('restoreBtn');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Restoring...';
    });
});
</script>
{% endblock %}
