<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Backup Report - {{ job_name }}</title>
    <!--[if mso]>
    <noscript>
        <xml>
            <o:OfficeDocumentSettings>
                <o:PixelsPerInch>96</o:PixelsPerInch>
            </o:OfficeDocumentSettings>
        </xml>
    </noscript>
    <![endif]-->
</head>
<body style="margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color: #f5f7fa; line-height: 1.6;">
    <!-- Container -->
    <table role="presentation" width="100%" cellspacing="0" cellpadding="0" style="background-color: #f5f7fa;">
        <tr>
            <td align="center" style="padding: 40px 20px;">
                <!-- Email Card - WIDER -->
                <table role="presentation" width="900" cellspacing="0" cellpadding="0" style="background-color: #ffffff; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); overflow: hidden; max-width: 100%;">
                    
                    <!-- Header -->
                    <tr>
                        <td style="background: linear-gradient(135deg, {% if failures_only %}#ef4444, #dc2626{% elif status == 'completed' %}#10b981, #059669{% elif status == 'partial' %}#f59e0b, #d97706{% else %}#ef4444, #dc2626{% endif %}); padding: 25px 40px; text-align: center;">
                            <table role="presentation" width="100%" cellspacing="0" cellpadding="0">
                                <tr>
                                    <td align="center">
                                        <h1 style="margin: 0; color: #ffffff; font-size: 22px; font-weight: 600;">
                                            {% if failures_only %}&#10007; Backup Failures Alert — {{ job_name }}{% elif status == 'completed' %}&#10003; Backup {{ status|title }} — {{ job_name }}{% elif status == 'partial' %}&#9888; Backup {{ status|title }} — {{ job_name }}{% else %}&#10007; Backup {{ status|title }} — {{ job_name }}{% endif %}
                                        </h1>
                                        {% if failures_only %}
                                        <p style="margin: 8px 0 0; color: rgba(255,255,255,0.9); font-size: 14px;">
                                            {{ failed_devices }} device{% if failed_devices != 1 %}s{% endif %} failed to backup
                                        </p>
                                        {% elif is_manual_run and triggered_by %}
                                        <p style="margin: 8px 0 0; color: rgba(255,255,255,0.9); font-size: 14px;">
                                            Triggered by {{ triggered_by }}
                                            <span style="display: inline-block; background: rgba(255,255,255,0.2); padding: 2px 8px; border-radius: 10px; margin-left: 8px; font-size: 11px; text-transform: uppercase;">Manual</span>
                                        </p>
                                        {% endif %}
                                    </td>
                                </tr>
                            </table>
                        </td>
                    </tr>
                    
                    <!-- Quick Stats Row -->
                    <tr>
                        <td style="padding: 25px 40px 15px;">
                            <table role="presentation" width="100%" cellspacing="0" cellpadding="0">
                                <tr>
                                    <!-- Success Rate -->
                                    <td width="16%" align="center" style="padding: 10px 5px;">
                                        <div style="font-size: 28px; font-weight: 700; color: {% if success_rate >= 90 %}#10b981{% elif success_rate >= 70 %}#f59e0b{% else %}#ef4444{% endif %};">{{ success_rate|floatformat:0 }}%</div>
                                        <div style="font-size: 11px; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px;">Success</div>
                                    </td>
                                    <!-- Total -->
                                    <td width="14%" align="center" style="padding: 10px 5px; border-left: 1px solid #e5e7eb;">
                                        <div style="font-size: 28px; font-weight: 700; color: #3b82f6;">{{ total_devices }}</div>
                                        <div style="font-size: 11px; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px;">Total</div>
                                    </td>
                                    <!-- OK -->
                                    <td width="14%" align="center" style="padding: 10px 5px; border-left: 1px solid #e5e7eb;">
                                        <div style="font-size: 28px; font-weight: 700; color: #10b981;">{{ successful_devices }}</div>
                                        <div style="font-size: 11px; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px;">OK</div>
                                    </td>
                                    <!-- Failed -->
                                    <td width="14%" align="center" style="padding: 10px 5px; border-left: 1px solid #e5e7eb;">
                                        <div style="font-size: 28px; font-weight: 700; color: {% if failed_devices > 0 %}#ef4444{% else %}#9ca3af{% endif %};">{{ failed_devices }}</div>
                                        <div style="font-size: 11px; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px;">Failed</div>
                                    </td>
                                    <!-- Changed -->
                                    <td width="12%" align="center" style="padding: 10px 5px; border-left: 1px solid #e5e7eb;">
                                        <div style="font-size: 28px; font-weight: 700; color: {% if changed_devices > 0 %}#f59e0b{% else %}#9ca3af{% endif %};">{{ changed_devices }}</div>
                                        <div style="font-size: 11px; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px;">Changed</div>
                                    </td>
                                    <!-- New Devices -->
                                    <td width="12%" align="center" style="padding: 10px 5px; border-left: 1px solid #e5e7eb;">
                                        <div style="font-size: 28px; font-weight: 700; color: {% if new_devices > 0 %}#8b5cf6{% else %}#9ca3af{% endif %};">{{ new_devices }}</div>
                                        <div style="font-size: 11px; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px;">New</div>
                                    </td>
                                    <!-- Duration -->
                                    <td width="14%" align="center" style="padding: 10px 5px; border-left: 1px solid #e5e7eb;">
                                        <div style="font-size: 20px; font-weight: 600; color: #374151;">{{ duration }}</div>
                                        <div style="font-size: 11px; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px;">Duration</div>
                                    </td>
                                    <!-- Time -->
                                    <td width="14%" align="center" style="padding: 10px 5px; border-left: 1px solid #e5e7eb;">
                                        <div style="font-size: 13px; font-weight: 500; color: #374151;">{{ started_at|slice:":17" }}</div>
                                        <div style="font-size: 11px; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px;">Started</div>
                                    </td>
                                </tr>
                            </table>
                        </td>
                    </tr>
                    
                    <!-- Device Table - Full Width, Clean Design -->
                    <tr>
                        <td style="padding: 10px 30px 30px;">
                            <table role="presentation" width="100%" cellspacing="0" cellpadding="0" style="border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden;">
                                <!-- Table Header -->
                                <tr style="background: #1f2937;">
                                    <th style="padding: 12px 12px; text-align: left; font-size: 12px; font-weight: 600; color: #ffffff; text-transform: uppercase; letter-spacing: 0.5px; width: 22%;">Device</th>
                                    <th style="padding: 12px 10px; text-align: left; font-size: 12px; font-weight: 600; color: #ffffff; text-transform: uppercase; letter-spacing: 0.5px; width: 15%;">IP Address</th>
                                    <th style="padding: 12px 10px; text-align: left; font-size: 12px; font-weight: 600; color: #ffffff; text-transform: uppercase; letter-spacing: 0.5px; width: 15%;">Group</th>
                                    <th style="padding: 12px 8px; text-align: center; font-size: 12px; font-weight: 600; color: #ffffff; text-transform: uppercase; letter-spacing: 0.5px; width: 10%;">Backup</th>
                                    <th style="padding: 12px 8px; text-align: center; font-size: 12px; font-weight: 600; color: #ffffff; text-transform: uppercase; letter-spacing: 0.5px; width: 12%;">Changes</th>
                                    <th style="padding: 12px 8px; text-align: center; font-size: 12px; font-weight: 600; color: #ffffff; text-transform: uppercase; letter-spacing: 0.5px; width: 12%;">Size</th>
                                    <th style="padding: 12px 8px; text-align: center; font-size: 12px; font-weight: 600; color: #ffffff; text-transform: uppercase; letter-spacing: 0.5px; width: 12%;">Duration</th>
                                </tr>
                                
                                {% for device in devices %}
                                <tr style="{% if forloop.counter|divisibleby:2 %}background: #f9fafb;{% else %}background: #ffffff;{% endif %}">
                                    <td style="padding: 10px 12px; border-bottom: 1px solid #e5e7eb;">
                                        <span style="font-weight: 600; color: #111827; font-size: 14px;">{{ device.hostname }}</span>
                                        {% if device.vendor %}<br><span style="font-size: 11px; color: #6b7280;">{{ device.vendor }}</span>{% endif %}
                                    </td>
                                    <td style="padding: 10px 10px; border-bottom: 1px solid #e5e7eb; font-family: 'SF Mono', Monaco, 'Courier New', monospace; font-size: 13px; color: #4b5563;">{{ device.ip_address }}</td>
                                    <td style="padding: 10px 10px; border-bottom: 1px solid #e5e7eb; font-size: 12px; color: #4b5563;">{{ device.group }}</td>
                                    <td style="padding: 10px 8px; border-bottom: 1px solid #e5e7eb; text-align: center;">
                                        {% if device.status == 'success' %}
                                        <span style="display: inline-block; padding: 3px 10px; background: #10b981; color: #ffffff; border-radius: 4px; font-size: 12px; font-weight: 600;">OK</span>
                                        {% elif device.status == 'failed' %}
                                        <span style="display: inline-block; padding: 3px 10px; background: #ef4444; color: #ffffff; border-radius: 4px; font-size: 12px; font-weight: 600;">FAILED</span>
                                        {% elif device.status == 'timeout' %}
                                        <span style="display: inline-block; padding: 3px 10px; background: #f59e0b; color: #ffffff; border-radius: 4px; font-size: 12px; font-weight: 600;">TIMEOUT</span>
                                        {% elif device.status == 'auth_error' %}
                                        <span style="display: inline-block; padding: 3px 10px; background: #ef4444; color: #ffffff; border-radius: 4px; font-size: 12px; font-weight: 600;">AUTH ERR</span>
                                        {% elif device.status == 'connection_error' %}
                                        <span style="display: inline-block; padding: 3px 10px; background: #ef4444; color: #ffffff; border-radius: 4px; font-size: 12px; font-weight: 600;">CONN ERR</span>
                                        {% else %}
                                        <span style="display: inline-block; padding: 3px 10px; background: #6b7280; color: #ffffff; border-radius: 4px; font-size: 12px; font-weight: 600;">{{ device.status|upper }}</span>
                                        {% endif %}
                                    </td>
                                    <td style="padding: 10px 8px; border-bottom: 1px solid #e5e7eb; text-align: center;">
                                        {% if device.has_changed == None %}
                                        <span style="color: #9ca3af; font-size: 12px;">N/A</span>
                                        {% elif device.is_first_backup %}
                                        <span style="display: inline-block; padding: 3px 10px; background: #8b5cf6; color: #ffffff; border-radius: 4px; font-size: 12px; font-weight: 600;">New Device</span>
                                        {% elif device.has_changed %}
                                        <span style="display: inline-block; padding: 3px 10px; background: #f59e0b; color: #ffffff; border-radius: 4px; font-size: 12px; font-weight: 600;">Changed!</span>
                                        {% else %}
                                        <span style="color: #6b7280; font-size: 12px;">None</span>
                                        {% endif %}
                                    </td>
                                    <td style="padding: 10px 8px; border-bottom: 1px solid #e5e7eb; text-align: center; font-size: 12px; color: #374151;">{{ device.size_formatted }}</td>
                                    <td style="padding: 10px 8px; border-bottom: 1px solid #e5e7eb; text-align: center; font-size: 12px; color: #374151;">{{ device.duration }}</td>
                                </tr>
                                {% if device.error_message %}
                                <tr style="{% if forloop.counter|divisibleby:2 %}background: #f9fafb;{% else %}background: #ffffff;{% endif %}">
                                    <td colspan="7" style="padding: 0 12px 10px; border-bottom: 1px solid #e5e7eb;">
                                        <div style="background: #fef2f2; border-left: 3px solid #ef4444; padding: 8px 12px; border-radius: 0 4px 4px 0; font-size: 12px; color: #991b1b;">
                                            {{ device.error_message }}
                                        </div>
                                    </td>
                                </tr>
                                {% endif %}
                                {% empty %}
                                <tr>
                                    <td colspan="7" style="padding: 30px; text-align: center; color: #6b7280; background: #f9fafb;">No devices in this backup job</td>
                                </tr>
                                {% endfor %}
                            </table>
                        </td>
                    </tr>
                    
                    {% if changed_devices > 0 %}
                    <!-- Changed Configs Note -->
                    <tr>
                        <td style="padding: 0 30px 20px;">
                            <div style="background: #fffbeb; border: 1px solid #fcd34d; border-radius: 8px; padding: 15px 20px;">
                                <p style="margin: 0; font-size: 14px; color: #92400e;">
                                    <strong>&#9888; {{ changed_devices }} device{% if changed_devices != 1 %}s{% endif %}</strong> had configuration changes since the last backup.
                                    Review the changes in the web interface.
                                </p>
                            </div>
                        </td>
                    </tr>
                    {% endif %}
                    
                    {% if new_devices > 0 %}
                    <!-- New Devices Note -->
                    <tr>
                        <td style="padding: 0 30px 20px;">
                            <div style="background: #f3e8ff; border: 1px solid #c4b5fd; border-radius: 8px; padding: 15px 20px;">
                                <p style="margin: 0; font-size: 14px; color: #6b21a8;">
                                    <strong>&#10024; {{ new_devices }} new device{% if new_devices != 1 %}s{% endif %}</strong> backed up for the first time.
                                </p>
                            </div>
                        </td>
                    </tr>
                    {% endif %}
                    
                    {% if archive_attached %}
                    <!-- Attachment Note -->
                    <tr>
                        <td style="padding: 0 30px 20px;">
                            <div style="background: #eff6ff; border: 1px solid #bfdbfe; border-radius: 8px; padding: 15px 20px;">
                                <p style="margin: 0; font-size: 14px; color: #1e40af;">
                                    <strong>&#128206; Attached:</strong> {{ archive_attached.filename }} ({{ archive_attached.size }})
                                    <br><span style="font-size: 12px; color: #3b82f6;">Contains all device configurations and additional command outputs from this backup job.</span>
                                </p>
                            </div>
                        </td>
                    </tr>
                    {% endif %}
                    
                    <!-- CTA Button -->
                    <tr>
                        <td style="padding: 10px 30px 30px;">
                            <table role="presentation" width="100%" cellspacing="0" cellpadding="0">
                                <tr>
                                    <td align="center">
                                        <a href="{{ app_url }}/backups/executions/{{ execution_id }}/" style="display: inline-block; padding: 12px 28px; background: #3b82f6; color: #ffffff; text-decoration: none; border-radius: 6px; font-weight: 600; font-size: 14px;">
                                            View Full Report &#8594;
                                        </a>
                                    </td>
                                </tr>
                            </table>
                        </td>
                    </tr>
                    
                    <!-- Footer -->
                    <tr>
                        <td style="background: #f9fafb; padding: 20px 30px; border-top: 1px solid #e5e7eb;">
                            <table role="presentation" width="100%" cellspacing="0" cellpadding="0">
                                <tr>
                                    <td align="center">
                                        <p style="margin: 0; font-size: 13px; font-weight: 600; color: #374151;">Sabra Device Backup</p>
                                        <p style="margin: 5px 0 0; font-size: 11px; color: #9ca3af;">
                                            Automated backup notification &#8226; {{ timestamp }}
                                        </p>
                                    </td>
                                </tr>
                            </table>
                        </td>
                    </tr>
                    
                </table>
            </td>
        </tr>
    </table>
</body>
</html>
